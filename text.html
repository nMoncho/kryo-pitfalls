<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 10.1.1" />
<title>Pitfalls in Kryo Serialization</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Pitfalls in Kryo Serialization</h1>
<span id="author">nMoncho</span><br />
<span id="revdate">2022-01-03</span>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>For one of our projects we serialize information coming from IoT devices into a Kafka topic, this
is later processed by several application which aggregate the information for different use cases
(e.g. notify user when room temperature has drop below a threshold). In the Java ecosystem we have
several tools to perform this serialization: <a href="https://thrift.apache.org/">Apache Thrift</a>,
<a href="https://avro.apache.org/">Apache Avro</a>, or <a href="https://developers.google.com/protocol-buffers">Google Protocol Buffers</a>
to name a few. In this project, though, we decided to use <a href="https://github.com/EsotericSoftware/kryo">Kryo</a>,
which offers another set of tradeoffs than the aforementioned libraries. Along the years we ran into several
pitfalls, my hope is that with this blogpost you can avoid making the same mistakes.</p></div>
<div class="paragraph"><p>You can check the companion code to this blogpost <a href="https://github.com/nMoncho/kryo-pitfalls">here</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>According to Kryo&#8217;s GitHub page:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Kryo is a fast and efficient binary object graph serialization framework for Java. The goals of the
project are high speed, low size, and an easy to use API. The project is useful any time objects need
to be persisted, whether to a file, database, or over the network.</p></div>
<div class="paragraph"><p>Kryo can also perform automatic deep and shallow copying/cloning. This is direct copying from object to
object, not object to bytes to object.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>This means that Kryo&#8217;s use case is, just like other serialization libraries, sharing data between parties
(i.e. between a writer and a reader). An important difference with other libraries is that we don&#8217;t have
to define a schema before we can start sending data (e.g. with Avro, we use
<a href="https://avro.apache.org/docs/current/idl.html">Avro IDL</a>), and this can be a source of problems if it&#8217;s not
handled carefully.</p></div>
<div class="sect2">
<h3 id="_registration">Registration</h3>
<div class="paragraph"><p>While working with Kryo, we can <em>optionally</em> register the classes that we want to serialize:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Person</span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">,</span> name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> age<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> alice <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #993399">1L</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Alice"</span><span style="color: #990000">,</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> kryo <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Kryo</span></span><span style="color: #990000">()</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.register</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>Person<span style="color: #990000">])</span>

<span style="font-style: italic"><span style="color: #9A1900">// Write</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> output <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Output</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileOutputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.writeObject</span></span><span style="color: #990000">(</span>output<span style="color: #990000">,</span> alice<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">output.close</span></span><span style="color: #990000">()</span>

<span style="font-style: italic"><span style="color: #9A1900">// Read</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> input <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Input</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileInputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> aliceFromFile <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">kryo.readObject</span></span><span style="color: #990000">(</span>input<span style="color: #990000">,</span> classOf<span style="color: #990000">[</span>Person<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">input.close</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>As mentioned, class registration is optional, but required by default, which can be disabled with
<code>kryo.setRegistrationRequired(false)</code>.</p></div>
<div class="paragraph"><p>If we analyze the output from both procedures we find them identical:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>❯ xxd object-with-registration<span style="color: #990000">.</span>bin
<span style="color: #993399">00000000</span><span style="color: #990000">:</span> <span style="color: #993399">0154</span> <span style="color: #993399">0201</span> 416c <span style="color: #993399">6963</span> e5                   <span style="color: #990000">.</span>T<span style="color: #990000">..</span>Alic<span style="color: #990000">.</span>

❯ xxd object-without-registration<span style="color: #990000">.</span>bin
<span style="color: #993399">00000000</span><span style="color: #990000">:</span> <span style="color: #993399">0154</span> <span style="color: #993399">0201</span> 416c <span style="color: #993399">6963</span> e5                   <span style="color: #990000">.</span>T<span style="color: #990000">..</span>Alic<span style="color: #990000">.</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pitfall_1_compatibility">Pitfall #1: Compatibility</h2>
<div class="sectionbody">
<div class="paragraph"><p>Initially one could be led to believe that there is no difference between registering and not registering
a class, but let&#8217;s take a look at the next snippet:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Message</span><span style="color: #990000">(</span>wholePayload<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> size<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">,</span> ts<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">)</span>  <span style="font-style: italic"><span style="color: #9A1900">// &lt;- New Message class</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Person</span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">,</span> name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> age<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> alice <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #993399">1L</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Alice"</span><span style="color: #990000">,</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> kryo <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Kryo</span></span><span style="color: #990000">()</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.register</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>Person<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.register</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>Message<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> output <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Output</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileOutputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.writeObject</span></span><span style="color: #990000">(</span>output<span style="color: #990000">,</span> alice<span style="color: #990000">)</span>                                <span style="font-style: italic"><span style="color: #9A1900">// &lt;--- Write a Person</span></span>
<span style="font-weight: bold"><span style="color: #000000">output.close</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> input <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Input</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileInputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> messageFromFile <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">kryo.readObject</span></span><span style="color: #990000">(</span>input<span style="color: #990000">,</span> classOf<span style="color: #990000">[</span>Message<span style="color: #990000">])</span> <span style="font-style: italic"><span style="color: #9A1900">// &lt;--- Read a Message</span></span>
<span style="font-weight: bold"><span style="color: #000000">input.close</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>This is perfectly valid, even if <code>Message</code> and <code>Person</code> are completely different, they have different field
names. The only similarity is that both classes have three fields with the same types, just with a different
order.
The reason why this works has to do with how <code>FieldSerializer</code> (the default serializer for objects) is
implemented:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>FieldSerializer is efficient by writing only the field data, without any schema information, using the
Java class files as the schema. It does not support adding, removing, or changing the type of fields
without invalidating previously serialized bytes. Renaming fields is allowed only if it doesn&#8217;t change
the alphabetical order of the fields.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Since both classes' fields, once sorted by name, define the same order:
&#8216;age, id, name` <code>==</code> <code>size, timestamp, wholePayload</code>,  Kryo deserializes a class&#8217; data into another class.
We can solve this issue if we replace both write and read methods with ones that include the classes inside
the payload:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Message</span><span style="color: #990000">(</span>wholePayload<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> size<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">,</span> ts<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Person</span><span style="color: #990000">(</span>id<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Long</span><span style="color: #990000">,</span> name<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> String<span style="color: #990000">,</span> age<span style="font-weight: bold"><span style="color: #0000FF">:</span></span> <span style="color: #009900">Int</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> alice <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #993399">1L</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Alice"</span><span style="color: #990000">,</span> <span style="color: #993399">42</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> kryo <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Kryo</span></span><span style="color: #990000">()</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.register</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>Person<span style="color: #990000">])</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.register</span></span><span style="color: #990000">(</span>classOf<span style="color: #990000">[</span>Message<span style="color: #990000">])</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> output <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Output</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileOutputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #000000">kryo.writeClassAndObject</span></span><span style="color: #990000">(</span>output<span style="color: #990000">,</span> alice<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">output.close</span></span><span style="color: #990000">()</span>

<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> input <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Input</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileInputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"file.bin"</span><span style="color: #990000">))</span>
<span style="font-weight: bold"><span style="color: #0000FF">val</span></span> personFromFile <span style="font-weight: bold"><span style="color: #0000FF">=</span></span> <span style="font-weight: bold"><span style="color: #000000">kryo.readClassAndObject</span></span><span style="color: #990000">(</span>input<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #000000">input.close</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that we no longer have to specify the <code>class</code> while reading. Thus we&#8217;re effectively trading schema
enforcement from <em>read</em> time to <em>write</em> time. Which coming full circle, if we attempt to do the same thing
but without registering both classes, we get different outputs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>❯ xxd class-and-object-with-registration<span style="color: #990000">.</span>bin
<span style="color: #993399">00000000</span><span style="color: #990000">:</span> 0c01 <span style="color: #993399">5402</span> <span style="color: #993399">0141</span> 6c69 <span style="color: #993399">63e5</span>                 <span style="color: #990000">..</span>T<span style="color: #990000">..</span>Alic<span style="color: #990000">.</span>

❯ xxd class-and-object-without-registration<span style="color: #990000">.</span>bin
<span style="color: #993399">00000000</span><span style="color: #990000">:</span> <span style="color: #993399">0100</span> <span style="color: #993399">6578</span> 616d 706c 652e <span style="color: #993399">4261</span> <span style="color: #993399">7369</span> 634b  <span style="color: #990000">..</span>example<span style="color: #990000">.</span>BasicK
<span style="color: #993399">00000010</span><span style="color: #990000">:</span> <span style="color: #993399">7279</span> 6f55 <span style="color: #993399">7361</span> <span style="color: #993399">6765</span> <span style="color: #993399">5370</span> <span style="color: #993399">6563</span> <span style="color: #993399">2450</span> <span style="color: #993399">6572</span>  ryoUsageSpec<span style="color: #009900">$Per</span>
<span style="color: #993399">00000020</span><span style="color: #990000">:</span> 736f ee01 <span style="color: #993399">5402</span> <span style="color: #993399">0141</span> 6c69 <span style="color: #993399">63e5</span>            so<span style="color: #990000">..</span>T<span style="color: #990000">..</span>Alic<span style="color: #990000">.</span></tt></pre></div></div>
<div class="paragraph"><p>The first serialization with registration includes the class identifier: &#8216;0c<code>. The rest of the payload is the
same as the ones produced by the previous example. The second serialization uses the class&#8217; fully qualified
name, which not only uses more space, but it&#8217;s also less performant. You can run `RegistrationBenchmark</code> to
compare the performance of both types, according to my numbers both speed and space increase between <em>10%</em>
and <em>20%</em>.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Serializing 50k Messages</caption>
<col width="33%" />
<col width="33%" />
<col width="33%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">With Registration</p></td>
<td align="left" valign="top"><p class="table">Without Registration</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">With Class in Payload</p></td>
<td align="left" valign="top"><p class="table">657.663051 ms</p></td>
<td align="left" valign="top"><p class="table">767.096071 m</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Without Class in Payload</p></td>
<td align="left" valign="top"><p class="table">600.054279 ms</p></td>
<td align="left" valign="top"><p class="table">763.372908 ms</p></td>
</tr>
</tbody>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src=".//speed.png" alt="Speed" />
</div>
<div class="title">Figure 1. Speed Comparison</div>
</div>
<div class="imageblock">
<div class="content">
<img src=".//space.png" alt="Speed" />
</div>
<div class="title">Figure 2. Space Comparison</div>
</div>
<div class="paragraph"><p><em>Figure 1</em> and <em>Figure 2</em> show a benchmark of the first row&#8217;s scenario, with and without registration with
class in playlod, for different sizes. First run serialized 10k objects, second run 20k, and so on.
This benchmark uses a similar class model from our IoT devices, defining a <code>Message</code> containing a list of <code>Signal</code>.</p></div>
<div class="paragraph"><p>Finally, <a href="https://github.com/twitter/chill">Twitter Chill</a> provides this fair warning:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Serialization compatibility is NOT guaranteed between releases, and for this reason, we don&#8217;t recommend
using it for long-term storage. Serialization is highly dependent on scala version compatibility and on
the underlying Kryo serializers, which take different approaches to compatibility.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p><strong>Conclusion:</strong> Registering classes makes Kryo more rigid, but it&#8217;s also faster, which, if we combine with
including the class in the payload, we avoid headaches at read time. If we desire to keep this reading safety
but be more flexible, we end up in the worst speed/space quadrant. This is not to say that&#8217;s useless, just
that you have to consider your use case carefully, as sometimes some speed/space penalty can be paid.</p></div>
<div class="paragraph"><p>Kryo also offers, like other serialization libraries, Backwards and Forwards compatibility, just not by
default, and we have to put extra thought into just another tradeoff. <em>There is no free lunch</em>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_pitfall_2_composition">Pitfall #2: Composition</h2>
<div class="sectionbody">
<div class="paragraph"><p>While serializing, both writer and reader must agree on the schema before they can start interacting.
Different libraries handle this differently, you can read about this on
<a href="https://martin.kleppmann.com/2012/12/05/schema-evolution-in-avro-protocol-buffers-thrift.html">Martin Kleppmann&#8217;s blogpost</a>.
On Kryo, they way this agreement is done is that both writer and schema must agree on the identifiers (e.g.
the <code>0c</code> ID from the previous section) they use for each of the classes involved (unless registration is
turned off and the class name is serialized inside the payload), which could also lead into problems.</p></div>
<div class="paragraph"><p>Imagine with have tree components: a Device, a Processor, and a Consumer. Each send information to the next
using Kryo (let&#8217;s ignore the medium for now).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+----------------+      +----------------+      +----------------+
|     Device     |-----&gt;|    Processor   |-----&gt;|    Consumer    |
+----------------+      +----------------+      +----------------+</code></pre>
</div></div>
<div class="paragraph"><p>And that <em>Device</em> declares the classes from the previous section: <code>Message</code>, <code>Signal</code>, etc. These are then
aggregated by <em>Processor</em> which defines its own classes: <code>Event</code> and <code>Notification</code>. Which are then consumed
by <em>Consumer</em> (this latter component doesn&#8217;t care about the first set of types).</p></div>
<div class="paragraph"><p>When registering classes, we cannot reuse IDs, otherwise we&#8217;d run into conflict or disagreement. For example,
imagine that both <em>Device</em> and <em>Processor</em> uses ID 10 for <code>Message</code> and that <em>Processor</em> use ID 11 for <code>Event</code>.
But after a few months of running in production, <em>Device</em> decides to use ID 11, which breaks <em>Processor</em>'s
operation.</p></div>
<div class="paragraph"><p>This, together with the performance requirement of using <a href="https://github.com/EsotericSoftware/kryo#pooling">Pooling</a>,
led <em>us</em> to try to stuff all registration inside a single pool, for which we created another common component
to hold and register every definition, in hopes to avoid this problem. If every class registration is in a
single place, there is no way writers and readers can disagree on the ID of a class.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+----------------+      +----------------+      +----------------+
|     Device     |-----&gt;|    Processor   |-----&gt;|    Consumer    |
+-------+--------+      +-------+--------+      +-------+--------+
        |                       |                       |
        |                       | (uses)                |
        |                       |                       |
        |               +----------------+              |
        |    (uses)     |    Models &amp;    |    (uses)    |
        +--------------&gt;|  Serialization |&lt;-------------+
                        +----------------+</code></pre>
</div></div>
<div class="paragraph"><p>Now the problem is that once the number of classes starts to grow this becomes harder to manage. Every change
in any given class requires an update this common library, even if the downstream component doesn&#8217;t use or
care about the change.</p></div>
<div class="paragraph"><p><strong>Conclusion:</strong> How to solve this issue? We&#8217;ve been bouncing ideas for several months, none of which entirely satisfied us.
Eventually I realised that this is a design problem, not an implementation one. We don&#8217;t need to stuff
everything into a single common component, as the boundaries between systems is <em>now</em> clearly defined. A
better solution would be for each component to expose both its models and serialization pool, since it&#8217;s
the component writing to the medium the one that knows which classes effectively end up there.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>+----------------+          +----------------+         +----------------+
|     Device     |---------&gt;|    Processor   |--------&gt;|    Consumer    |
+-+--------------+-+        +-+--+-----------+----+    +---------+------+
  |    Models &amp;    |  (uses)  |  |  Models &amp;      |      (uses)  |
  |  Serialization |&lt;---------+  |  Serialization |&lt;-------------+
  +----------------+             +----------------+</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_pitfall_3_persistence">Pitfall #3: Persistence</h2>
<div class="sectionbody">
<div class="paragraph"><p>Right off the bat we&#8217;ve contradictory information, on the one hand we&#8217;re told: "The project is useful any
time objects need  to be persisted, whether to a file, database, or over the network". But on the other
we&#8217;re told: "Serialization compatibility is NOT guaranteed between releases, and for this reason, we
don&#8217;t recommend using it for long-term storage". Writing to a file or a database may be long-term, and if
we consider the aforementioned pitfalls, it seems we should lean on the latter rather than the former.</p></div>
<div class="paragraph"><p>On Pitfall #2, I mentioned that the medium wasn&#8217;t relevant to the discussion, but now consider we ignore
everything we mentioned in the previous section, and we serialize information into a Kafka topic. If at any
moment the writer decides to switch registered IDs, we&#8217;ll end up with a Kafka topic where some part of the
topic is with one set of IDs and another part with another set. Which means consumers can only consume one
part of the topic.</p></div>
<div class="paragraph"><p>This problem forces us to this serialization problem ourselves, to which regretfully I cannot offer a suitable
solution :(</p></div>
<div class="paragraph"><p>A potential solution could involve just waiting until downstream components have been updated to the new
registration IDs, but requires explicit knowledge of the change. If these components are developed and
monitored by different teams, the latter could panic while noticing messages aren&#8217;t processed.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2022-01-04 10:31:55 CET
</div>
</div>
</body>
</html>
